{% extends "base.html" %}
{% load static %}

{% block title %}AfriTube - Home{% endblock %}

{% block content %}
<div class="youtube-container">
    <div class="content-wrapper">
        <!-- Live Streams Section with Horizontal Scroll -->
        {% if live_streams %}
        <section class="content-section live-section">
            <div class="section-header">
                <h2 class="section-title">
                    <i class="bi bi-broadcast live-icon"></i>
                    Live
                </h2>
                <div class="scroll-controls">
                    <button class="scroll-btn scroll-left" id="scrollLeft" disabled>
                        <i class="bi bi-chevron-left"></i>
                    </button>
                    <button class="scroll-btn scroll-right" id="scrollRight">
                        <i class="bi bi-chevron-right"></i>
                    </button>
                </div>
            </div>
            <div class="live-scroll-container" id="liveScrollContainer">
                <div class="live-scroll-content">
                    {% for stream in live_streams %}
                    <div class="live-item">
                        <a href="{% url 'stream_detail' stream.stream_id %}" class="video-link">
                            <div class="thumbnail-wrapper live-thumbnail">
                                <img src="{{ stream.thumbnail.url }}" alt="{{ stream.title }}" class="thumbnail">
                                <div class="live-badge">
                                    <span class="live-dot"></span>
                                    LIVE
                                </div>
                                <span class="viewer-badge">
                                    <i class="bi bi-eye-fill"></i>
                                    {{ stream.current_viewers|default:"0" }}
                                </span>
                            </div>
                            <div class="video-metadata">
                                <img src="{{ stream.creator.get_profile_picture_url }}" alt="{{ stream.creator.username }}" class="channel-avatar">
                                <div class="video-info">
                                    <h3 class="video-title">{{ stream.title }}</h3>
                                    <p class="channel-name">{{ stream.creator.channel_name|default:stream.creator.username }}</p>
                                </div>
                            </div>
                        </a>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </section>
        {% endif %}

        <!-- Shorts Section -->
        {% if shorts %}
        <section class="content-section">
            <div class="section-header">
                <h2 class="section-title">
                    <i class="bi bi-play-btn shorts-icon"></i>
                    Shorts
                </h2>
            </div>
            <div class="shorts-grid">
                {% for short in shorts %}
                <div class="short-item">
                    <a href="{% url 'video_detail' short.video_id %}" class="short-link">
                        <div class="short-thumbnail">
                            <img src="{{ short.thumbnail.url }}" alt="{{ short.title }}" class="short-img">
                            <div class="short-views-badge">
                                <i class="bi bi-eye"></i> {{ short.view_count|default:"0" }}
                            </div>
                        </div>
                        <p class="short-title">{{ short.title|truncatechars:40 }}</p>
                    </a>
                </div>
                {% endfor %}
            </div>
        </section>
        {% endif %}

        <!-- Main Videos Section with Infinite Scroll -->
        <section class="content-section">
            <div class="video-grid" id="videoGrid">
                {% include 'partials/video_grid_items.html' %}
            </div>

            <!-- Loading Spinner -->
            <div class="loading-spinner" id="loadingSpinner" style="display: none;">
                <div class="spinner"></div>
                <p>Loading more videos...</p>
            </div>

            <!-- No More Videos Message -->
            <div class="no-more-videos" id="noMoreVideos" style="display: none;">
                <i class="bi bi-check-circle"></i>
                <p>You've reached the end</p>
            </div>

            <!-- Empty State -->
            {% if not videos and not recommended_videos %}
            <div class="empty-state">
                <i class="bi bi-film empty-icon"></i>
                <h3>No videos available</h3>
                <p>Check back later for new content</p>
            </div>
            {% endif %}
        </section>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    /* Modern YouTube-like Layout */
    .youtube-container {
        background: #f9f9f9;
        min-height: 100vh;
        padding-top: 56px;
    }

    .content-wrapper {
        max-width: 1920px;
        margin: 0 auto;
        padding: 24px 24px 48px;
    }

    /* Section Styles */
    .content-section {
        margin-bottom: 48px;
    }

    .section-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 16px;
        padding: 0 0 12px 0;
    }

    .section-title {
        font-size: 20px;
        font-weight: 600;
        color: #030303;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .live-icon,
    .shorts-icon {
        font-size: 24px;
        color: #ff0000;
    }

    /* Live Streams Horizontal Scroll */
    .live-section {
        position: relative;
    }

    .scroll-controls {
        display: flex;
        gap: 8px;
    }

    .scroll-btn {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: none;
        background: white;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
    }

    .scroll-btn:hover:not(:disabled) {
        background: #f2f2f2;
        transform: scale(1.05);
    }

    .scroll-btn:disabled {
        opacity: 0.3;
        cursor: not-allowed;
    }

    .scroll-btn i {
        font-size: 20px;
        color: #606060;
    }

    .live-scroll-container {
        position: relative;
        overflow: hidden;
        margin: 0 -8px;
    }

    .live-scroll-content {
        display: flex;
        gap: 16px;
        padding: 0 8px;
        overflow-x: auto;
        scroll-behavior: smooth;
        scrollbar-width: none;
        -ms-overflow-style: none;
    }

    .live-scroll-content::-webkit-scrollbar {
        display: none;
    }

    .live-item {
        flex: 0 0 380px;
        max-width: 380px;
    }

    .live-thumbnail {
        aspect-ratio: 16/9;
    }

    /* Video Grid */
    .video-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 24px 16px;
    }

    .video-item {
        background: transparent;
    }

    .video-link {
        text-decoration: none;
        color: inherit;
        display: block;
    }

    .thumbnail-wrapper {
        position: relative;
        width: 100%;
        aspect-ratio: 16/9;
        border-radius: 12px;
        overflow: hidden;
        background: #e5e5e5;
        margin-bottom: 12px;
        transition: transform 0.2s;
    }

    .video-item:hover .thumbnail-wrapper {
        transform: scale(1.02);
    }

    .thumbnail {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
    }

    /* Video Preview on Hover */
    .video-preview {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        opacity: 0;
        transition: opacity 0.3s;
        pointer-events: none;
    }

    .video-item:hover .video-preview {
        opacity: 1;
    }

    .video-item:hover .thumbnail {
        opacity: 0;
    }

    .duration {
        position: absolute;
        bottom: 6px;
        right: 6px;
        background: rgba(0, 0, 0, 0.85);
        color: white;
        padding: 3px 6px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 500;
        font-family: 'Roboto', sans-serif;
        z-index: 2;
    }

    .live-badge {
        position: absolute;
        top: 8px;
        left: 8px;
        background: #cc0000;
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 6px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        z-index: 2;
    }

    .live-dot {
        width: 6px;
        height: 6px;
        background: white;
        border-radius: 50%;
        animation: pulse 2s ease-in-out infinite;
    }

    .viewer-badge {
        position: absolute;
        bottom: 6px;
        left: 6px;
        background: rgba(0, 0, 0, 0.85);
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 4px;
        z-index: 2;
    }

    .badge-premium {
        position: absolute;
        top: 8px;
        left: 8px;
        background: linear-gradient(135deg, #ffd700, #ffed4e);
        color: #000;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 4px;
        z-index: 2;
    }

    .badge-ppv {
        position: absolute;
        top: 8px;
        left: 8px;
        background: #065fd4;
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 4px;
        z-index: 2;
    }

    .video-metadata {
        display: flex;
        gap: 12px;
    }

    .channel-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        flex-shrink: 0;
        object-fit: cover;
    }

    .video-info {
        flex: 1;
        min-width: 0;
    }

    .video-title {
        font-size: 14px;
        font-weight: 500;
        color: #030303;
        line-height: 1.4;
        margin: 0 0 4px 0;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .channel-name {
        font-size: 12px;
        color: #606060;
        margin: 0 0 2px 0;
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .channel-name i {
        font-size: 14px;
        color: #606060;
    }

    .video-stats {
        font-size: 12px;
        color: #606060;
        margin: 0;
    }

    /* Shorts Grid */
    .shorts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 16px;
    }

    .short-item {
        background: transparent;
    }

    .short-link {
        text-decoration: none;
        color: inherit;
        display: block;
    }

    .short-thumbnail {
        position: relative;
        width: 100%;
        aspect-ratio: 9/16;
        border-radius: 12px;
        overflow: hidden;
        background: #e5e5e5;
        margin-bottom: 8px;
        transition: transform 0.2s;
    }

    .short-item:hover .short-thumbnail {
        transform: scale(1.02);
    }

    .short-img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .short-views-badge {
        position: absolute;
        bottom: 8px;
        left: 8px;
        color: white;
        font-size: 12px;
        font-weight: 500;
        text-shadow: 0 1px 3px rgba(0,0,0,0.6);
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .short-title {
        font-size: 14px;
        font-weight: 500;
        color: #030303;
        margin: 0;
        line-height: 1.4;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    /* Loading Spinner */
    .loading-spinner {
        text-align: center;
        padding: 40px 20px;
    }

    .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #065fd4;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 16px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .loading-spinner p {
        color: #606060;
        font-size: 14px;
        margin: 0;
    }

    .no-more-videos {
        text-align: center;
        padding: 40px 20px;
        color: #606060;
    }

    .no-more-videos i {
        font-size: 48px;
        color: #065fd4;
        margin-bottom: 12px;
    }

    .no-more-videos p {
        font-size: 14px;
        margin: 0;
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 80px 20px;
    }

    .empty-icon {
        font-size: 120px;
        color: #909090;
        margin-bottom: 24px;
    }

    .empty-state h3 {
        font-size: 20px;
        font-weight: 400;
        color: #030303;
        margin: 0 0 8px 0;
    }

    .empty-state p {
        font-size: 14px;
        color: #606060;
        margin: 0;
    }

    /* Animation */
    @keyframes pulse {
        0%, 100% {
            opacity: 1;
        }
        50% {
            opacity: 0.4;
        }
    }

    /* Responsive Design */
    @media (max-width: 1200px) {
        .video-grid {
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        }
        
        .live-item {
            flex: 0 0 320px;
            max-width: 320px;
        }
    }

    @media (max-width: 900px) {
        .content-wrapper {
            padding: 16px 16px 32px;
        }

        .video-grid {
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 16px 12px;
        }

        .live-item {
            flex: 0 0 280px;
            max-width: 280px;
        }

        .shorts-grid {
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
        }

        .scroll-controls {
            display: none;
        }

        .live-scroll-content {
            overflow-x: scroll;
        }
    }

    @media (max-width: 600px) {
        .content-wrapper {
            padding: 12px 12px 24px;
        }

        .video-grid {
            grid-template-columns: 1fr;
            gap: 12px;
        }

        .shorts-grid {
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .section-title {
            font-size: 18px;
        }

        .video-title {
            font-size: 13px;
        }

        .channel-avatar {
            width: 32px;
            height: 32px;
        }

        .live-item {
            flex: 0 0 260px;
            max-width: 260px;
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Infinite Scroll
    let loading = false;
    let hasMore = {{ has_more|yesno:"true,false" }};
    let nextPage = {{ next_page }};
    const videoGrid = document.getElementById('videoGrid');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const noMoreVideos = document.getElementById('noMoreVideos');

    function loadMoreVideos() {
        if (loading || !hasMore) return;

        loading = true;
        loadingSpinner.style.display = 'block';

        fetch(`?page=${nextPage}`, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            loadingSpinner.style.display = 'none';
            
            if (data.html) {
                videoGrid.insertAdjacentHTML('beforeend', data.html);
                initVideoPreview(); // Re-initialize preview for new videos
            }
            
            hasMore = data.has_more;
            nextPage = data.next_page;
            loading = false;

            if (!hasMore) {
                noMoreVideos.style.display = 'block';
            }
        })
        .catch(error => {
            console.error('Error loading videos:', error);
            loadingSpinner.style.display = 'none';
            loading = false;
        });
    }

    // Detect scroll near bottom
    window.addEventListener('scroll', () => {
        if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 500) {
            loadMoreVideos();
        }
    });

    // Video Preview on Hover
    function initVideoPreview() {
        const videoItems = document.querySelectorAll('.video-item');
        
        videoItems.forEach(item => {
            const preview = item.querySelector('.video-preview');
            if (!preview) return;

            let hoverTimeout;

            item.addEventListener('mouseenter', () => {
                hoverTimeout = setTimeout(() => {
                    preview.play().catch(e => console.log('Preview play failed:', e));
                }, 500); // Wait 500ms before playing
            });

            item.addEventListener('mouseleave', () => {
                clearTimeout(hoverTimeout);
                preview.pause();
                preview.currentTime = 0;
            });
        });
    }

    initVideoPreview();

    // Live Streams Horizontal Scroll
    const liveScrollContainer = document.getElementById('liveScrollContainer');
    const scrollLeft = document.getElementById('scrollLeft');
    const scrollRight = document.getElementById('scrollRight');

    if (liveScrollContainer && scrollLeft && scrollRight) {
        const scrollContent = liveScrollContainer.querySelector('.live-scroll-content');

        function updateScrollButtons() {
            const scrollLeft_val = scrollContent.scrollLeft;
            const scrollWidth = scrollContent.scrollWidth;
            const clientWidth = scrollContent.clientWidth;

            scrollLeft.disabled = scrollLeft_val <= 0;
            scrollRight.disabled = scrollLeft_val + clientWidth >= scrollWidth - 1;
        }

        scrollLeft.addEventListener('click', () => {
            scrollContent.scrollBy({ left: -400, behavior: 'smooth' });
        });

        scrollRight.addEventListener('click', () => {
            scrollContent.scrollBy({ left: 400, behavior: 'smooth' });
        });

        scrollContent.addEventListener('scroll', updateScrollButtons);
        updateScrollButtons();

        // Touch scroll for mobile
        let isDown = false;
        let startX;
        let scrollLeftPos;

        scrollContent.addEventListener('mousedown', (e) => {
            isDown = true;
            startX = e.pageX - scrollContent.offsetLeft;
            scrollLeftPos = scrollContent.scrollLeft;
        });

        scrollContent.addEventListener('mouseleave', () => {
            isDown = false;
        });

        scrollContent.addEventListener('mouseup', () => {
            isDown = false;
        });

        scrollContent.addEventListener('mousemove', (e) => {
            if (!isDown) return;
            e.preventDefault();
            const x = e.pageX - scrollContent.offsetLeft;
            const walk = (x - startX) * 2;
            scrollContent.scrollLeft = scrollLeftPos - walk;
        });
    }
});
</script>
{% endblock %}